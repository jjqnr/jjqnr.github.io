<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>小鱼干音乐小屋</title>
    <meta name="viewport" content="initial-scale=1, maximum-scale=1">
    <link rel="shortcut icon" href="/favicon.ico">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">

    <link rel="stylesheet" href="//g.alicdn.com/msui/sm/0.6.2/css/sm.min.css">
    <link rel="stylesheet" href="//g.alicdn.com/msui/sm/0.6.2/css/sm-extend.min.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous">
    <link rel="stylesheet" href="./public/css/index.css">
</head>
</head>

<body>
<div class="page-group">
    <div class="page">
        <nav class="bar bar-tab">
            <a class="tab-item active" href="index.html">
                <span class="icon icon-home"></span>
                <span class="tab-label">首页</span>
            </a>
            <a class="tab-item" href="music.html">
                <span class="icon icon-star"></span>
                <span class="tab-label">音乐</span>
            </a>
            <a class="tab-item" href="video.html">
                <span class="icon icon-share"></span>
                <span class="tab-label">视频</span>
            </a>
            <a class="tab-item" href="owner.html">
                <span class="icon icon-me"></span>
                <span class="tab-label">艺环</span>
            </a>
        </nav>
        <div class="content">
            <!--audio标签-->
            <audio src="./public/music/meet.mp3"></audio>
            <!--歌曲信息-->
            <div class="song-info-box">
                <div class="song-info-txt"><span class="song-name">蓝</span>-<span class="song-author">艺环</span></div>
                <div class="poster-box"><img src="./public/video/yh2.jpeg" class="music-poster"></div>
            </div>
            <!--时间进度条-->
            <div class="content-box">
                <div class="left-box played-progress">00：00</div>
                <div class="center-box"> <div class="slider-bar">
                    <div class="slider-progress">
                        <div class="slider-dot-control"></div>
                    </div>
                </div></div>
                <div class="right-box all-progress">00：00</div>
            </div>
            <!--控制按钮-->
            <div class="control-box">
                <span class="prev_bt fa fa-step-backward iconfont" title="上一首"></span>
                <span class="play_bt fa fa-play-circle" title="播放/暂停"></span>
                <span class="next_bt fa fa-step-forward iconfont" title="下一首"></span>
            </div>
            <!--歌曲列表-->
            <div class="music-list-box">
                <div class="music-list-title">歌曲列表</div>
                <div class="music-list-body">
                    <table>
                        <thead>
                        <tr>
                            <th>歌名</th><th>歌手</th><th>时长</th>
                        </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>
</div>

<script type='text/javascript' src='//g.alicdn.com/sj/lib/zepto/zepto.min.js' charset='utf-8'></script>
<script type='text/javascript' src='//g.alicdn.com/msui/sm/0.6.2/js/sm.min.js' charset='utf-8'></script>
<script type='text/javascript' src='//g.alicdn.com/msui/sm/0.6.2/js/sm-extend.min.js' charset='utf-8'></script>
<script>
    $(function () {
        var songs=[
            {title:"遇见",author:"蓝艺环",src:"./public/music/meet.mp3",image:"./public/video/yh2.jpeg",long:"5.0minute"},
            {title:"遇见",author:"蓝艺环",src:"./public/music/demo.mp3",image:"./public/video/yh3.jpeg",long:"5.2minute"}];
        var curIndex=0;

        //预先设置获取需要使用的数据和参数
        var lastX=0;
        var power=false;
        var silider=document.querySelector('.slider-bar');
        var progress=document.querySelector('.slider-progress');
        var dot=document.querySelector('.slider-dot-control');
        var audio=document.querySelector('audio');
        var playBtn=document.querySelector('.play_bt');
        var poster=document.querySelector('.music-poster');
        var songName=document.querySelector('.song-name');
        var songAuthor=document.querySelector('.song-author');
        var prevSong=document.querySelector('.prev_bt');
        var nextSong=document.querySelector('.next_bt');
        //        设置时间滑块事件
        dot.addEventListener('touchstart',function (e) {
            var touch=e.touches[0];
            power=true;
            lastX=touch.clientX;
        })
        document.addEventListener('touchmove',function (e) {
            var touch=e.touches[0];
            if(power){
                var curX=touch.clientX;
                var addW=curX-lastX;
                var setW=progress.offsetWidth+addW;
                var maxW=silider.offsetWidth;
                if(setW>=0&&setW<=maxW){
                    lastX=curX;
                    var percen=setW/maxW;
                }else if(setW<0){
                    percen=0;
                }else {
                    percen=1;
                }
                progress.style.width=percen*100+"%";
            }
        })
        document.addEventListener('touchend',function (e) {
            if(power){
                var setW=progress.offsetWidth;
                var maxW=silider.offsetWidth;
                if(setW>=0&&setW<=maxW){
                    var percen=setW/maxW;
                }else if(setW<0){
                    percen=0;
                }else {
                    percen=1;
                }
                progress.style.width=percen*100+"%";
                upDateProgress(percen);
            }
            power=false;
        })
        silider.addEventListener('click',function (e) {
            var setW=e.clientX-this.offsetLeft;
            var maxW=silider.offsetWidth;
            if(setW>=0&&setW<=maxW){
                var percen=setW/maxW;
                progress.style.width=percen*100+"%";
                upDateProgress(percen)
            }
        })
        //        上一曲
        prevSong.onclick=function () {
            curIndex--;
            if(curIndex<0){
                curIndex=songs.length-1;
            }
            changeSong(curIndex);
            setTimeout(function () {
                audio.play();
            },200)
        }
        //        下一曲
        nextSong.onclick=function () {
            curIndex++;
            if(curIndex>=songs.length){
                curIndex=0;
            }
            changeSong(curIndex);
            setTimeout(function () {
                audio.play();
            },200)
        }
        //        更改进度条
        function upDateProgress(percence) {
            audio.currentTime=percence*audio.duration;
        }
        //        切换歌曲
        function changeSong(index) {
            if((0<=index)&&(index<songs.length)){
                var curSong=songs[index];
                audio.src=curSong.src;
                poster.src=curSong.image;
                songName.innerHTML=curSong.title;
                songAuthor.innerHTML=curSong.author;
            }
        }
        //        监听播放事件
        audio.onplay=function () {
            playBtn.className='play_bt fa fa-play-circle';
            poster.className='playing music-poster';
        }
        //        监听暂停事件
        audio.onpause=function () {
            playBtn.className='play_bt fa fa-stop-circle';
            poster.className='music-poster';
        }
        //        播放或暂停
        playBtn.onclick=function () {
            if(audio.paused){
                audio.play()
            }else {
                audio.pause()
            }
        }
        //        监听可以播放事件
        audio.oncanplay=function () {
            document.querySelector('.all-progress').innerHTML=duration(parseInt(audio.duration))
            if(!power){
                var prence=audio.currentTime/audio.duration;
                progress.style.width=prence*100+"%";
            }
            if(audio.paused){
                playBtn.className='play_bt fa fa-play-circle';
                poster.className='music-poster';
            }else {
                playBtn.className='play_bt fa fa-stop-circle';
                poster.className='playing music-poster';
            }
        }
        //        监听播放时间变化事件
        audio.ontimeupdate=function () {
            document.querySelector('.played-progress').innerHTML=duration(parseInt(audio.currentTime))
            if(!power){
                var prence=audio.currentTime/audio.duration;
                progress.style.width=prence*100+"%";
            }
        }
        //        监听播放结束事件
        audio.onended=function () {
            curIndex++;
            if(curIndex>=songs.length){
                curIndex=0;
            }
            changeSong(curIndex);
            setTimeout(function () {
                audio.play();
            },200)
        }
        //        格式化时间格式
        var duration=function (time) {
            var fen=parseInt(time/60);
            var miao=time%60;
            if(fen<=9){
                fen="0"+fen;
            }
            if(miao<=9){
                miao="0"+miao;
            }
            return fen+'：'+miao;
        }
        changeSong(0);
        setList(songs);
        //        初始化显示歌曲列表
        function setList(songs) {
            var list=document.querySelector('table tbody');
            songs.forEach(function (song,idx){
                var html='<tr onclick="playSong('+idx+')"><td>'+song.title+'</td><td>'+song.author+'</td><td>'+ song.long + '</td></tr>';
                list.innerHTML+=html;
            })
        }
        //        播放指定位置的歌曲
        function playSong(i) {
            if(curIndex!=i){
                curIndex=i;
                changeSong(curIndex);
            }else {
                audio.play();
            }
        }
    })
</script>

</body>
</html>